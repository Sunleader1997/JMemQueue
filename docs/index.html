<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JMemQueue - é«˜æ€§èƒ½è·¨è¿›ç¨‹å…±äº«å†…å­˜é˜Ÿåˆ—ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            text-align: center;
            padding: 40px 20px;
            background: radial-gradient(circle at center, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
        }

        .logo {
            width: 100px;
            height: 100px;
            margin-bottom: 15px;
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }

        h1 {
            font-size: 3em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-shadow: 0 0 40px rgba(102, 126, 234, 0.3);
        }

        .subtitle {
            font-size: 1.3em;
            color: #a0a0a0;
            margin-bottom: 8px;
        }

        .tagline {
            font-size: 1em;
            color: #6366f1;
        }

        /* Features Grid */
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 40px;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.5);
        }

        .feature-icon {
            font-size: 1.8em;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .feature-title {
            font-size: 1.1em;
            margin-bottom: 8px;
            color: #e0e0e0;
        }

        .feature-desc {
            color: #888;
            line-height: 1.5;
            font-size: 0.95em;
        }

        /* Animation Section */
        .animation-section {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 40px;
        }

        .section-title {
            text-align: center;
            font-size: 1.8em;
            margin-bottom: 8px;
            color: #e0e0e0;
        }

        .section-desc {
            text-align: center;
            color: #888;
            margin-bottom: 25px;
            font-size: 0.95em;
        }

        #animationCanvas {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            display: block;
            margin: 0 auto;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .control-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .control-btn:active {
            transform: translateY(0);
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: #888;
            margin-top: 5px;
            font-size: 0.9em;
        }

        /* Architecture Section */
        .architecture {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 40px;
        }

        .arch-diagram {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }

        .arch-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 18px;
            transition: all 0.3s ease;
        }

        .arch-card:hover {
            border-color: rgba(102, 126, 234, 0.5);
        }

        .arch-title {
            color: #6366f1;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .arch-desc {
            color: #888;
            line-height: 1.5;
            font-size: 0.9em;
        }

        /* Performance Section */
        .performance {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 40px;
        }

        .perf-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }

        .perf-item {
            text-align: center;
            padding: 25px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .perf-item:hover {
            transform: scale(1.03);
            border-color: rgba(102, 126, 234, 0.5);
        }

        .perf-value {
            font-size: 2.2em;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .perf-label {
            color: #888;
            margin-top: 8px;
            font-size: 0.95em;
        }

        .perf-note {
            color: #666;
            font-size: 0.85em;
            margin-top: 5px;
        }

        /* Quick Start */
        .quick-start {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 40px;
        }

        .code-block {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            overflow-x: auto;
        }

        .code-block pre {
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .keyword { color: #569cd6; }
        .string { color: #ce9178; }
        .comment { color: #6a9955; }
        .class-name { color: #4ec9b0; }
        .method { color: #dcdcaa; }
        .number { color: #b5cea8; }

        /* Footer */
        footer {
            text-align: center;
            padding: 30px;
            color: #666;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        footer a {
            color: #6366f1;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        footer a:hover {
            color: #764ba2;
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 { font-size: 2em; }
            .subtitle { font-size: 1em; }
            #animationCanvas { width: 100%; height: auto; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <svg class="logo" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <rect x="20" y="20" width="160" height="160" rx="30" fill="url(#grad1)" opacity="0.1"/>
                <rect x="30" y="30" width="140" height="140" rx="20" fill="url(#grad1)" opacity="0.2"/>
                <rect x="40" y="40" width="120" height="120" rx="15" fill="url(#grad1)" opacity="0.3"/>
                <text x="100" y="115" text-anchor="middle" font-size="40" font-weight="bold" fill="url(#grad1)">SMQ</text>
            </svg>
            <h1>JMemQueue</h1>
            <div class="subtitle">é«˜æ€§èƒ½è·¨è¿›ç¨‹å…±äº«å†…å­˜é˜Ÿåˆ—ç³»ç»Ÿ</div>
            <div class="tagline">åŸºäº Java NIO å’Œå†…å­˜æ˜ å°„æ–‡ä»¶çš„é›¶æ‹·è´é€šä¿¡è§£å†³æ–¹æ¡ˆ</div>
        </header>

        <!-- Features -->
        <section class="features">
            <div class="feature-card">
                <div class="feature-icon">âš¡</div>
                <div class="feature-title">é›¶æ‹·è´æœºåˆ¶</div>
                <div class="feature-desc">åŸºäºå†…å­˜æ˜ å°„æ–‡ä»¶ï¼Œé¿å…ä¸å¿…è¦çš„å†…å­˜å¤åˆ¶ï¼Œå®ç°æè‡´ä½å»¶è¿Ÿ</div>
            </div>
            <div class="feature-card">
                <div class="feature-icon">ğŸ”“</div>
                <div class="feature-title">æ— é”å¹¶å‘</div>
                <div class="feature-desc">ä½¿ç”¨ CAS åŸå­æ“ä½œç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼Œçº¿ç¨‹Aæ‹¿åˆ°offsetæ—¶çº¿ç¨‹Bä¸å¿…ç­‰å¾…</div>
            </div>
            <div class="feature-card">
                <div class="feature-icon">ğŸ“Š</div>
                <div class="feature-title">é«˜ååé‡</div>
                <div class="feature-desc">å•çº¿ç¨‹æ¯ç§’å¯å¤„ç†æ•°ç™¾ä¸‡æ¡æ¶ˆæ¯ï¼Œå¤šçº¿ç¨‹æ¶ˆè´¹å¯è¾¾åƒä¸‡çº§åˆ«</div>
            </div>
            <div class="feature-card">
                <div class="feature-icon">ğŸ”„</div>
                <div class="feature-title">è´Ÿè½½å‡è¡¡</div>
                <div class="feature-desc">åŒä¸€ä¸ª GROUP çš„æ¶ˆè´¹è€…ä¸ä¼šæ¶ˆè´¹åˆ°é‡å¤æ•°æ®ï¼Œæ”¯æŒå¤šè¿›ç¨‹å¤šæœåŠ¡</div>
            </div>
            <div class="feature-card">
                <div class="feature-icon">ğŸ’¾</div>
                <div class="feature-title">æŒä¹…åŒ–å­˜å‚¨</div>
                <div class="feature-desc">æ•°æ®å­˜å‚¨åœ¨æ“ä½œç³»ç»Ÿé¡µé¢ç¼“å­˜ä¸­ï¼Œæ”¯æŒæ–­ç”µä¸ä¸¢å¤±</div>
            </div>
            <div class="feature-card">
                <div class="feature-icon">ğŸ“ˆ</div>
                <div class="feature-title">å¯æ‰©å±•æ¶æ„</div>
                <div class="feature-desc">æ”¯æŒåŠ¨æ€è½¦å¢æ‰©å®¹ï¼Œå¯é…ç½®æ•°æ®å…ƒå¤§å°ï¼Œæ”¯æŒ TB çº§æ•°æ®å­˜å‚¨</div>
            </div>
        </section>

        <!-- Animation Section -->
        <section class="animation-section">
            <h2 class="section-title">SGM å¤šçº¿ç¨‹æ•°æ®å­˜å–æµç¨‹æ¼”ç¤º</h2>
            <p class="section-desc">çœŸå®æ¨¡æ‹Ÿï¼šProducer CAS è·å– offset â†’ mmap è½¦å¢ â†’ å†™å…¥ SGM â†’ Consumer å¹¶å‘è¯»å–ï¼ˆå›ºå®šä¸¤ä¸ªè½¦å¢ï¼‰</p>
            <canvas id="animationCanvas" width="1000" height="450"></canvas>
            <div class="controls">
                <button class="control-btn" onclick="startAnimation()">â–¶ å¼€å§‹æ¼”ç¤º</button>
                <button class="control-btn" onclick="pauseAnimation()">â¸ æš‚åœ</button>
                <button class="control-btn" onclick="resetAnimation()">â†º é‡ç½®</button>
            </div>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="statOffset">0</div>
                    <div class="stat-label">å…¨å±€ Offset</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statProduced">0</div>
                    <div class="stat-label">ç”Ÿäº§æ¶ˆæ¯æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statConsumed">0</div>
                    <div class="stat-label">æ¶ˆè´¹æ¶ˆæ¯æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statCarriages">1</div>
                    <div class="stat-label">è½¦å¢æ•°é‡</div>
                </div>
            </div>
        </section>

        <!-- Architecture -->
        <section class="architecture">
            <h2 class="section-title">æ ¸å¿ƒæ¶æ„è®¾è®¡</h2>
            <p class="section-desc">JMemQueue é‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œå„ç»„ä»¶èŒè´£æ¸…æ™°</p>

            <div class="arch-diagram">
                <div class="arch-card">
                    <div class="arch-title">JSharedMemQueue</div>
                    <div class="arch-desc">ä¸»é˜Ÿåˆ—æ¥å£ï¼Œæä¾› enqueue() å’Œ createReader() æ–¹æ³•</div>
                </div>
                <div class="arch-card">
                    <div class="arch-title">JSharedMemBaseInfo</div>
                    <div class="arch-desc">ç»´æŠ¤å…¨å±€ offsetï¼Œæä¾› CAS åŸå­æ“ä½œè·å–å¹¶é€’å¢ offset</div>
                </div>
                <div class="arch-card">
                    <div class="arch-title">JSharedMemCarriage</div>
                    <div class="arch-desc">é€»è¾‘è½¦å¢ï¼Œç®¡ç†å¤šä¸ª SGMï¼ŒThreadLocal ç»´æŠ¤é¿å…ç«æ€</div>
                </div>
                <div class="arch-card">
                    <div class="arch-title">JSharedMemSegment</div>
                    <div class="arch-desc">å•ä¸ªå†…å­˜æ®µï¼Œæ¯ä¸ª SGM å›ºå®šå¤§å°ï¼ŒåŒ…å«çŠ¶æ€ã€å¤§å°ã€å†…å®¹</div>
                </div>
                <div class="arch-card">
                    <div class="arch-title">JSharedMemProducer</div>
                    <div class="arch-desc">ç”Ÿäº§è€…ï¼ŒThreadLocal ç»´æŠ¤è½¦å¢ï¼ŒCAS è·å– offset é¡ºåºå†™å…¥</div>
                </div>
                <div class="arch-card">
                    <div class="arch-title">JSharedMemReader</div>
                    <div class="arch-desc">æ¶ˆè´¹è€…ï¼Œæ¯ä¸ª GROUP ç‹¬ç«‹ offsetï¼Œå¹¶å‘è¯»å–å¯è¯»æ•°æ®</div>
                </div>
            </div>
        </section>

        <!-- Performance -->
        <section class="performance">
            <h2 class="section-title">æ€§èƒ½åŸºå‡†</h2>
            <p class="section-desc">åœ¨å…¸å‹ç¡¬ä»¶ç¯å¢ƒä¸‹ï¼ˆIntel i7, 16GB RAMï¼‰çš„æµ‹è¯•æ•°æ®</p>

            <div class="perf-grid">
                <div class="perf-item">
                    <div class="perf-value">200ä¸‡+</div>
                    <div class="perf-label">Windows å•çº¿ç¨‹</div>
                    <div class="perf-note">æ¡æ¶ˆæ¯/ç§’</div>
                </div>
                <div class="perf-item">
                    <div class="perf-value">600ä¸‡+</div>
                    <div class="perf-label">Windows 4çº¿ç¨‹</div>
                    <div class="perf-note">å¤šè¿›ç¨‹æ¶ˆè´¹</div>
                </div>
                <div class="perf-item">
                    <div class="perf-value">1800ä¸‡+</div>
                    <div class="perf-label">Linux 4çº¿ç¨‹</div>
                    <div class="perf-note">å¤šè¿›ç¨‹æ¶ˆè´¹</div>
                </div>
                <div class="perf-item">
                    <div class="perf-value">&lt;1Î¼s</div>
                    <div class="perf-label">å¹³å‡å»¶è¿Ÿ</div>
                    <div class="perf-note">å¾®ç§’çº§å“åº”</div>
                </div>
            </div>
        </section>

        <!-- Quick Start -->
        <section class="quick-start">
            <h2 class="section-title">å¿«é€Ÿå¼€å§‹</h2>

            <div style="margin-top: 25px;">
                <h3 style="color: #e0e0e0; margin-bottom: 12px;">ç”Ÿäº§è€…ç¤ºä¾‹</h3>
                <div class="code-block">
                    <pre>
// åˆ›å»ºå…±äº«å†…å­˜é˜Ÿåˆ—
JSharedMemQueue queue = new JSharedMemQueue("my-topic", 2048);
JSharedMemProducer producer = queue.createProducer();
// å¦‚æœéœ€è¦å®šä¹‰æ•°æ®æ¸…ç†æœºåˆ¶
// producer.setTimeToLive(1, TimeUnit.DAYS);

// å†™å…¥æ•°æ®
String message = "Hello, Shared Memory Queue!";
byte[] data = message.getBytes(StandardCharsets.UTF_8);
boolean success = producer.enqueue(data);
                    </pre>
                </div>
            </div>

            <div style="margin-top: 25px;">
                <h3 style="color: #e0e0e0; margin-bottom: 12px;">æ¶ˆè´¹è€…ç¤ºä¾‹</h3>
                <div class="code-block">
                    <pre>
import io.github.sunleader1997.jmemqueue.JSharedMemQueue;
import io.github.sunleader1997.jmemqueue.JSharedMemReader;

// åˆ›å»ºé˜Ÿåˆ—å®ä¾‹
JSharedMemQueue queue = new JSharedMemQueue("my-topic", 2048);

// åˆ›å»ºè¯»å–å™¨
JSharedMemReader reader = queue.createReader();

// æ¶ˆè´¹æ¶ˆæ¯
byte[] data = reader.dequeue();
if(data !=null){
    String message = new String(data, StandardCharsets.UTF_8);
    System.out.println("æ”¶åˆ°æ¶ˆæ¯: "+message);
}
                    </pre>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer>
            <p>JMemQueue - Apache License 2.0</p>
            <p style="margin-top: 8px;">
                <a href="https://github.com/sunleader1997/JMemQueue" target="_blank">GitHub</a> |
                <a href="https://github.com/sunleader1997/JMemQueue/issues" target="_blank">Issues</a>
            </p>
        </footer>
    </div>

    <script>
        // Canvas Animation
        const canvas = document.getElementById('animationCanvas');
        const ctx = canvas.getContext('2d');

        let animationId;
        let isRunning = false;
        let startTime;

        // Colors
        const colors = {
            bg: '#0a0a0a',
            baseInfo: '#667eea',
            producer: '#4ec9b0',
            consumer: '#ff6b6b',
            carriage: '#2a2a3e',
            sgmIdle: '#3a3a4e',
            sgmWriting: '#ffa500',
            sgmReadable: '#00ff88',
            sgmReading: '#ff6b6b',
            text: '#e0e0e0',
            grid: 'rgba(255, 255, 255, 0.05)'
        };

        // Global state
        let globalOffset = 0;
        const CARRIAGE_CAPACITY = 8; // æ¯ä¸ªè½¦å¢çš„ SGM æ•°é‡
        const SGM_SIZE = 60; // SGM å—å¤§å°
        const MAX_CARRIAGES = 2; // åªå±•ç¤ºä¸¤ä¸ªè½¦å¢

        // BaseInfo
        const baseInfo = {
            x: 500,
            y: 40,
            width: 180,
            height: 50
        };

        // Disk area (for mmap demo)
        const diskArea = {
            x: 500,
            y: 430,
            width: 200,
            height: 60
        };

        // Producers
        const producers = [];
        const NUM_PRODUCERS = 3;

        // Consumers
        const consumers = [];
        const NUM_CONSUMERS = 2;

        // Carriages (å›ºå®šä¸¤ä¸ªè½¦å¢)
        let carriages = [];

        // Particles (åŠ¨ç”»æ•ˆæœ)
        const particles = [];

        // Stats
        let producedCount = 0;
        let consumedCount = 0;

        class Producer {
            constructor(x, y, id) {
                this.x = x;
                this.y = y;
                this.id = id;
                this.width = 90;
                this.height = 70;
                this.lastProduceTime = 0;
                this.produceInterval = 2500 + Math.random() * 1500;
                this.currentOffset = -1;
                this.waiting = false;
                this.active = false;
            }

            draw() {
                // Producer box
                ctx.fillStyle = this.active ? 'rgba(78, 201, 176, 0.4)' : 'rgba(78, 201, 176, 0.15)';
                ctx.strokeStyle = colors.producer;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.roundRect(this.x - this.width/2, this.y - this.height/2, this.width, this.height, 8);
                ctx.fill();
                ctx.stroke();

                // Producer icon
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('P' + (this.id + 1), this.x, this.y + 6);

                // State label
                ctx.font = '10px Arial';
                ctx.fillStyle = this.waiting ? '#ffa500' : '#888';
                ctx.fillText(this.waiting ? 'CAS...' : 'Producer', this.x, this.y + this.height/2 + 12);
            }

            update(currentTime) {
                if (!this.waiting && !this.active && currentTime - this.lastProduceTime > this.produceInterval) {
                    this.waiting = true;
                    this.lastProduceTime = currentTime;

                    // å°è¯• CAS è·å– offset
                    setTimeout(() => {
                        const success = this.tryCAS();
                        if (success) {
                            this.waiting = false;
                            this.active = true;
                            setTimeout(() => { this.active = false; }, 200);
                        } else {
                            // CAS å¤±è´¥ï¼Œç¨åé‡è¯•
                            setTimeout(() => { this.waiting = false; }, 100);
                        }
                    }, Math.random() * 300 + 200);
                }
            }

            tryCAS() {
                // æ¨¡æ‹Ÿ CAS æ“ä½œï¼Œ90% æˆåŠŸç‡
                if (Math.random() > 0.1) {
                    // æ£€æŸ¥æ˜¯å¦è¶…å‡ºè½¦å¢èŒƒå›´ï¼ˆä¸¤ä¸ªè½¦å¢ï¼Œå…± 16 ä¸ªä½ç½®ï¼‰
                    if (globalOffset >= MAX_CARRIAGES * CARRIAGE_CAPACITY) {
                        return false; // è½¦å¢å·²æ»¡
                    }

                    const offset = globalOffset;
                    globalOffset++;
                    this.currentOffset = offset;
                    updateStats();

                    // è®¡ç®—è½¦å¢å’Œ SGM ä½ç½®
                    const carriageIndex = Math.floor(offset / CARRIAGE_CAPACITY);
                    const sgmIndex = offset % CARRIAGE_CAPACITY;

                    // ç¡®ä¿è½¦å¢å­˜åœ¨ï¼ˆæœ€å¤šä¸¤ä¸ªè½¦å¢ï¼‰
                    while (carriages.length <= carriageIndex && carriages.length < MAX_CARRIAGES) {
                        createNewCarriage();
                    }

                    const carriage = carriages[carriageIndex];
                    if (!carriage || !carriage.mmapped) {
                        return false; // è½¦å¢æœª mmap å®Œæˆ
                    }

                    const sgmPos = this.getSGMPosition(carriageIndex, sgmIndex);

                    // åˆ›å»º CAS æˆåŠŸåŠ¨ç”»
                    particles.push(new CASParticle(
                        baseInfo.x,
                        baseInfo.y + baseInfo.height / 2,
                        sgmPos.x,
                        sgmPos.y,
                        offset,
                        'write'
                    ));

                    return true;
                }
                return false;
            }

            getSGMPosition(carriageIndex, sgmIndex) {
                const carriage = carriages[carriageIndex];
                const sgmPerRow = 4;
                const row = Math.floor(sgmIndex / sgmPerRow);
                const col = sgmIndex % sgmPerRow;
                return {
                    x: carriage.x - carriage.width / 2 + 20 + col * (SGM_SIZE + 10) + SGM_SIZE / 2,
                    y: carriage.y - carriage.height / 2 + 30 + row * (SGM_SIZE + 10) + SGM_SIZE / 2
                };
            }
        }

        class Consumer {
            constructor(x, y, id) {
                this.x = x;
                this.y = y;
                this.id = id;
                this.width = 90;
                this.height = 70;
                this.lastConsumeTime = 0;
                this.consumeInterval = 1500 + Math.random() * 1000;
                this.consumerOffset = 0; // æ¯ä¸ªæ¶ˆè´¹è€…ç‹¬ç«‹çš„ offset
                this.waiting = false;
                this.active = false;
            }

            draw() {
                // Consumer box
                ctx.fillStyle = this.active ? 'rgba(255, 107, 107, 0.4)' : 'rgba(255, 107, 107, 0.15)';
                ctx.strokeStyle = colors.consumer;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.roundRect(this.x - this.width/2, this.y - this.height/2, this.width, this.height, 8);
                ctx.fill();
                ctx.stroke();

                // Consumer icon
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('C' + (this.id + 1), this.x, this.y + 6);

                // State label
                ctx.font = '10px Arial';
                ctx.fillStyle = this.waiting ? '#ffa500' : '#888';
                ctx.fillText(this.waiting ? 'CAS...' : 'Consumer', this.x, this.y + this.height/2 + 12);
            }

            update(currentTime) {
                if (!this.waiting && !this.active && currentTime - this.lastConsumeTime > this.consumeInterval) {
                    this.waiting = true;
                    this.lastConsumeTime = currentTime;

                    // å°è¯• CAS è·å–æ¶ˆè´¹ offset
                    setTimeout(() => {
                        if (this.consumerOffset >= globalOffset) {
                            this.waiting = false;
                            return;
                        }

                        const success = this.tryCAS();
                        if (success) {
                            this.waiting = false;
                            this.active = true;
                            setTimeout(() => { this.active = false; }, 200);
                        } else {
                            setTimeout(() => { this.waiting = false; }, 100);
                        }
                    }, Math.random() * 300 + 200);
                }
            }

            tryCAS() {
                if (Math.random() > 0.1) {
                    const offset = this.consumerOffset;
                    this.consumerOffset++;

                    const carriageIndex = Math.floor(offset / CARRIAGE_CAPACITY);
                    const sgmIndex = offset % CARRIAGE_CAPACITY;

                    if (carriageIndex < carriages.length) {
                        const carriage = carriages[carriageIndex];
                        if (carriage.sgms[sgmIndex].state === 'readable') {
                            const sgmPos = this.getSGMPosition(carriageIndex, sgmIndex);

                            // åˆ›å»ºè¯»å–åŠ¨ç”»
                            particles.push(new CASParticle(
                                sgmPos.x,
                                sgmPos.y,
                                this.x - this.width / 2,
                                this.y,
                                offset,
                                'read'
                            ));

                            // æ ‡è®°ä¸ºè¯»å–ä¸­
                            carriage.sgms[sgmIndex].state = 'reading';
                            setTimeout(() => {
                                carriage.sgms[sgmIndex].state = 'idle';
                            }, 800);

                            consumedCount++;
                            updateStats();
                            return true;
                        }
                    }
                }
                return false;
            }

            getSGMPosition(carriageIndex, sgmIndex) {
                const carriage = carriages[carriageIndex];
                const sgmPerRow = 4;
                const row = Math.floor(sgmIndex / sgmPerRow);
                const col = sgmIndex % sgmPerRow;
                return {
                    x: carriage.x - carriage.width / 2 + 20 + col * (SGM_SIZE + 10) + SGM_SIZE / 2,
                    y: carriage.y - carriage.height / 2 + 30 + row * (SGM_SIZE + 10) + SGM_SIZE / 2
                };
            }
        }

        class Carriage {
            constructor(x, y, id) {
                this.x = x;
                this.y = y;
                this.id = id;
                this.width = 320;
                this.height = 180;
                this.sgms = [];
                this.mmapped = false; // æ˜¯å¦å·²å®Œæˆ mmap
                for (let i = 0; i < CARRIAGE_CAPACITY; i++) {
                    this.sgms.push({ state: 'idle', index: i });
                }
            }

            draw() {
                // ç»˜åˆ¶ mmap è™šçº¿è¿æ¥ç£ç›˜å’Œè½¦å¢
                const diskX = this.id === 0 ? diskArea.x - 110 : diskArea.x + 110;
                const diskY = diskArea.y - diskArea.height / 2 + 25;
                const carriageBottomY = this.y + this.height / 2 + 20;

                // ç£ç›˜æ–‡ä»¶å›¾æ ‡
                ctx.fillStyle = 'rgba(102, 126, 234, 0.2)';
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.roundRect(diskX - 80, diskY - 25, 160, 50, 8);
                ctx.fill();
                ctx.stroke();

                ctx.fillStyle = '#e0e0e0';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(this.id + '.carriage', diskX, diskY + 5);
                ctx.font = '10px Arial';
                ctx.fillStyle = '#888';
                ctx.fillText('Disk File', diskX, diskY + 23);

                // mmap åŠ¨æ€è™šçº¿
                const dashOffset = (Date.now() / 50) % 20;
                ctx.beginPath();
                ctx.moveTo(diskX, diskY + 30);
                ctx.lineTo(this.x, carriageBottomY);
                ctx.strokeStyle = this.mmapped ? 'rgba(102, 126, 234, 0.5)' : 'rgba(102, 126, 234, 0.2)';
                ctx.lineWidth = 2;
                ctx.setLineDash([10, 10]);
                ctx.lineDashOffset = -dashOffset;
                ctx.stroke();
                ctx.setLineDash([]);

                // mmap æ ‡ç­¾
                ctx.fillStyle = this.mmapped ? '#667eea' : '#888';
                ctx.font = this.mmapped ? 'bold 11px Arial' : '11px Arial';
                ctx.fillText(this.mmapped ? 'mmap()' : 'mapping...', diskX + 25, (diskY + carriageBottomY) / 2);

                // Carriage box
                ctx.fillStyle = colors.carriage;
                ctx.strokeStyle = 'rgba(102, 126, 234, 0.4)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.roundRect(this.x - this.width/2, this.y - this.height/2, this.width, this.height, 10);
                ctx.fill();
                ctx.stroke();

                // Carriage label
                ctx.fillStyle = '#e0e0e0';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Carriage ' + this.id, this.x, this.y - this.height/2 - 8);

                // SGMs
                const sgmPerRow = 4;
                for (let i = 0; i < this.sgms.length; i++) {
                    const row = Math.floor(i / sgmPerRow);
                    const col = i % sgmPerRow;

                    const sgmX = this.x - this.width/2 + 20 + col * (SGM_SIZE + 10) + SGM_SIZE / 2;
                    const sgmY = this.y - this.height/2 + 30 + row * (SGM_SIZE + 10) + SGM_SIZE / 2;

                    // SGM color based on state
                    let sgmColor;
                    switch (this.sgms[i].state) {
                        case 'idle':
                            sgmColor = colors.sgmIdle;
                            break;
                        case 'writing':
                            sgmColor = colors.sgmWriting;
                            break;
                        case 'readable':
                            sgmColor = colors.sgmReadable;
                            break;
                        case 'reading':
                            sgmColor = colors.sgmReading;
                            break;
                    }

                    ctx.fillStyle = sgmColor;
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.roundRect(sgmX - SGM_SIZE/2, sgmY - SGM_SIZE/2, SGM_SIZE, SGM_SIZE, 5);
                    ctx.fill();
                    ctx.stroke();

                    // SGM index
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 12px Arial';
                    ctx.fillText(this.sgms[i].index, sgmX, sgmY + 4);
                }
            }
        }

        class CASParticle {
            constructor(startX, startY, endX, endY, offset, type) {
                this.startX = startX;
                this.startY = startY;
                this.endX = endX;
                this.endY = endY;
                this.offset = offset;
                this.type = type; // 'write' or 'read'
                this.progress = 0;
                this.speed = 0.025;
                this.complete = false;
            }

            update() {
                this.progress += this.speed;
                if (this.progress >= 1) {
                    this.progress = 1;
                    this.complete = true;

                    if (this.type === 'write') {
                        const carriageIndex = Math.floor(this.offset / CARRIAGE_CAPACITY);
                        const sgmIndex = this.offset % CARRIAGE_CAPACITY;
                        if (carriageIndex < carriages.length) {
                            carriages[carriageIndex].sgms[sgmIndex].state = 'writing';
                            producedCount++;
                            updateStats();

                            // æ¨¡æ‹Ÿå†™å…¥æ—¶é—´
                            setTimeout(() => {
                                carriages[carriageIndex].sgms[sgmIndex].state = 'readable';
                            }, 300);
                        }
                    }
                }
            }

            draw() {
                const x = this.startX + (this.endX - this.startX) * this.progress;
                const y = this.startY + (this.endY - this.startY) * this.progress;

                // Trail
                ctx.beginPath();
                ctx.moveTo(this.startX, this.startY);
                ctx.lineTo(x, y);
                ctx.strokeStyle = this.type === 'write'
                    ? `rgba(78, 201, 176, ${0.5 * this.progress})`
                    : `rgba(255, 107, 107, ${0.5 * this.progress})`;
                ctx.lineWidth = 3;
                ctx.stroke();

                // Particle
                ctx.beginPath();
                ctx.arc(x, y, 10, 0, Math.PI * 2);
                ctx.fillStyle = this.type === 'write' ? colors.producer : colors.consumer;
                ctx.fill();

                // Glow
                ctx.beginPath();
                ctx.arc(x, y, 15, 0, Math.PI * 2);
                ctx.fillStyle = this.type === 'write'
                    ? 'rgba(78, 201, 176, 0.3)'
                    : 'rgba(255, 107, 107, 0.3)';
                ctx.fill();

                // Offset label
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('#' + this.offset, x, y - 20);
            }
        }

        function createNewCarriage() {
            const x = 320 + carriages.length * 320;
            const y = 250;
            const carriageId = carriages.length;
            carriages.push(new Carriage(x, y, carriageId));

            // å»¶è¿Ÿå®Œæˆ mmap
            setTimeout(() => {
                if (carriages[carriageId]) {
                    carriages[carriageId].mmapped = true;
                }
            }, 2000);
        }

        function init() {
            // åˆ›å»ºç¬¬ä¸€ä¸ªè½¦å¢ï¼ˆå¿«é€Ÿå®Œæˆ mmapï¼‰
            const carriage1 = new Carriage(320, 250, 0);
            carriage1.mmapped = true; // ç«‹å³å®Œæˆ mmap
            carriages.push(carriage1);

            // å»¶è¿Ÿåˆ›å»ºç¬¬äºŒä¸ªè½¦å¢
            setTimeout(() => {
                if (carriages.length < MAX_CARRIAGES) {
                    createNewCarriage();
                }
            }, 3000);

            // åˆ›å»ºç”Ÿäº§è€…
            for (let i = 0; i < NUM_PRODUCERS; i++) {
                producers.push(new Producer(80, 150 + i * 100, i));
            }

            // åˆ›å»ºæ¶ˆè´¹è€…
            for (let i = 0; i < NUM_CONSUMERS; i++) {
                consumers.push(new Consumer(920, 180 + i * 100, i));
            }
        }

        function drawBackground() {
            // Background
            ctx.fillStyle = colors.bg;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Grid
            ctx.strokeStyle = colors.grid;
            ctx.lineWidth = 1;
            for (let i = 0; i < canvas.width; i += 40) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, canvas.height);
                ctx.stroke();
            }
            for (let i = 0; i < canvas.height; i += 40) {
                ctx.beginPath();
                ctx.moveTo(0, i);
                ctx.lineTo(canvas.width, i);
                ctx.stroke();
            }

            // Labels
            ctx.fillStyle = '#666';
            ctx.font = '13px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Producers', 80, 40);
            ctx.fillText('BaseInfo', 500, 25);
            ctx.fillText('Carriages (Shared Memory)', 560, 25);
            ctx.fillText('Consumers', 920, 40);
            ctx.fillText('Disk Files', 500, 400);

            // Arrow labels
            ctx.font = '11px Arial';
            ctx.fillStyle = '#888';
            ctx.fillText('CAS â†’', 200, 425);
            ctx.fillText('â†’ Read', 800, 425);
        }

        function drawBaseInfo() {
            // BaseInfo box
            ctx.fillStyle = 'rgba(102, 126, 234, 0.15)';
            ctx.strokeStyle = colors.baseInfo;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.roundRect(baseInfo.x - baseInfo.width/2, baseInfo.y - baseInfo.height/2, baseInfo.width, baseInfo.height, 8);
            ctx.fill();
            ctx.stroke();

            // Title
            ctx.fillStyle = '#e0e0e0';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Global Offset', baseInfo.x, baseInfo.y - 8);

            // Offset value
            ctx.fillStyle = colors.baseInfo;
            ctx.font = 'bold 20px Arial';
            ctx.fillText(globalOffset.toString(), baseInfo.x, baseInfo.y + 15);
        }

        function updateStats() {
            document.getElementById('statOffset').textContent = globalOffset;
            document.getElementById('statProduced').textContent = producedCount;
            document.getElementById('statConsumed').textContent = consumedCount;
            document.getElementById('statCarriages').textContent = carriages.length;
        }

        function animate() {
            if (!isRunning) return;

            const currentTime = Date.now();

            // Clear canvas
            drawBackground();

            // Draw BaseInfo
            drawBaseInfo();

            // Draw carriages
            carriages.forEach(carriage => carriage.draw());

            // Update and draw producers
            producers.forEach(producer => {
                producer.update(currentTime);
                producer.draw();
            });

            // Update and draw consumers
            consumers.forEach(consumer => {
                consumer.update(currentTime);
                consumer.draw();
            });

            // Update and draw particles
            particles.forEach((particle, index) => {
                particle.update();
                particle.draw();
            });

            // Remove completed particles
            for (let i = particles.length - 1; i >= 0; i--) {
                if (particles[i].complete) {
                    particles.splice(i, 1);
                }
            }

            animationId = requestAnimationFrame(animate);
        }

        function startAnimation() {
            if (!isRunning) {
                isRunning = true;
                if (!startTime) {
                    startTime = Date.now();
                    // ç¬¬ä¸€ä¸ªç”Ÿäº§è€…ç«‹å³å¼€å§‹ç”Ÿäº§ï¼ˆä»offset 0å¼€å§‹ï¼‰
                    producers[0].lastProduceTime = 0;
                }
                animate();
            }
        }

        function pauseAnimation() {
            isRunning = false;
            cancelAnimationFrame(animationId);
        }

        function resetAnimation() {
            pauseAnimation();
            globalOffset = 0;
            producedCount = 0;
            consumedCount = 0;
            startTime = null;
            particles.length = 0;
            carriages = [];
            consumers.forEach(c => c.consumerOffset = 0);

            // åˆ›å»ºç¬¬ä¸€ä¸ªè½¦å¢ï¼ˆç«‹å³å®Œæˆ mmapï¼‰
            const carriage1 = new Carriage(320, 250, 0);
            carriage1.mmapped = true;
            carriages.push(carriage1);

            // å»¶è¿Ÿåˆ›å»ºç¬¬äºŒä¸ªè½¦å¢
            setTimeout(() => {
                if (carriages.length < MAX_CARRIAGES) {
                    createNewCarriage();
                }
            }, 3000);

            updateStats();

            drawBackground();
            drawBaseInfo();
            carriages.forEach(carriage => carriage.draw());
            producers.forEach(producer => producer.draw());
            consumers.forEach(consumer => consumer.draw());
        }

        // Initialize
        init();
        resetAnimation();
    </script>
</body>
</html>
