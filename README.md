<div align="center">
  <img src="./ICON.png" width="200"/>
</div>

# <div align="center"><strong>JMemQueue</strong></div>

### <div align="center">é«˜æ€§èƒ½è·¨è¿›ç¨‹å…±äº«å†…å­˜é˜Ÿåˆ—ç³»ç»Ÿ</div>

# JMemQueue - é«˜æ€§èƒ½è·¨è¿›ç¨‹å…±äº«å†…å­˜é˜Ÿåˆ—ç³»ç»Ÿ

JMemQueue æ˜¯ä¸€ä¸ªåŸºäº Java NIO å’Œå…±äº«å†…å­˜æŠ€æœ¯æ„å»ºçš„é«˜æ€§èƒ½è·¨è¿›ç¨‹é€šä¿¡ï¼ˆIPCï¼‰è§£å†³æ–¹æ¡ˆï¼Œåˆ©ç”¨å†…å­˜æ˜ å°„æ–‡ä»¶ï¼ˆMappedByteBufferï¼‰å®ç°ä½å»¶è¿Ÿã€é«˜ååé‡çš„æ•°æ®ä¼ è¾“ã€‚

# é€‚ç”¨åœºæ™¯
ï¼ˆç®€è€Œè¨€ä¹‹ï¼Œåœ¨å•æœºåœºæ™¯ä¸‹æ›¿ä»£ Kafkaï¼Œè¦æ¯”kafkaæ›´å¿«ï¼ä¼ è¾“æ•°æ®ä¸èƒ½å±€é™äºå­—ç¬¦ä¸²ï¼‰
- å•æœºæœåŠ¡å™¨
- å¤šè¿›ç¨‹å¤šæœåŠ¡éœ€è¦é«˜æ•ˆä½å»¶è¿Ÿé€šä¿¡

## ğŸš€ ç‰¹æ€§

- **é›¶æ‹·è´æœºåˆ¶**ï¼šåŸºäºå†…å­˜æ˜ å°„æ–‡ä»¶ï¼Œé¿å…ä¸å¿…è¦çš„å†…å­˜å¤åˆ¶
- **æ— é”å¹¶å‘**ï¼šä½¿ç”¨ CASï¼ˆCompare-And-Swapï¼‰æ“ä½œç¡®ä¿çº¿ç¨‹å®‰å…¨
- **é«˜ååé‡**ï¼šå•çº¿ç¨‹æ¯ç§’å¯å¤„ç†æ•°ç™¾ä¸‡æ¡æ¶ˆæ¯
- **è´Ÿè½½å‡è¡¡**ï¼šåŒä¸€ä¸ªGROUPä¸ä¼šæ¶ˆè´¹åˆ°é‡å¤æ•°æ®
- **è·¨è¿›ç¨‹é€šä¿¡**ï¼šæ”¯æŒä¸åŒ JVM è¿›ç¨‹é—´çš„é«˜æ•ˆæ•°æ®äº¤æ¢
- **æŒä¹…åŒ–å­˜å‚¨**ï¼šæ•°æ®åœ¨æ“ä½œç³»ç»Ÿé¡µé¢ç¼“å­˜ä¸­ï¼Œæ–­ç”µä¸ä¸¢å¤±ï¼ˆå¦‚å¯ç”¨æŒä¹…åŒ–ï¼‰
- **å¯æ‰©å±•æ¶æ„**ï¼šæ”¯æŒåŠ¨æ€æ‰©å®¹å’Œè´Ÿè½½å‡è¡¡

## ğŸ“Š æ¶æ„è®¾è®¡

### æ•°æ®ç»“æ„ - SMG (Shared Memory Grid)

æ¯ä¸ªæ•°æ®å•å…ƒï¼ˆSMGï¼‰å ç”¨ 1024 å­—èŠ‚ï¼Œç»“æ„å¦‚ä¸‹ï¼š

| åç§»é‡    | å¤§å°      | æè¿°                                                                     |
|--------|---------|------------------------------------------------------------------------|
| 0-3    | 4 å­—èŠ‚    | çŠ¶æ€å­—æ®µï¼ˆSTATE_IDLE=0, STATE_WRITING=1, STATE_READABLE=2, STATE_READING=3ï¼‰ |
| 4-7    | 4 å­—èŠ‚    | æ•°æ®å¤§å°ï¼ˆå®é™…å†…å®¹é•¿åº¦ï¼‰                                                           |
| 8-1023 | 1016 å­—èŠ‚ | å®é™…æ•°æ®å†…å®¹                                                                 |

### æ ¸å¿ƒç»„ä»¶

#### 1. JSharedMemQueue

- ä¸»é˜Ÿåˆ—æ¥å£ï¼Œæä¾› `enqueue()` å’Œ `createReader()` æ–¹æ³•
- ç®¡ç†å…¨å±€åç§»é‡å’Œè½¦å¢åˆ†é…

#### 2. JSharedMemBaseInfo

- ç»´æŠ¤é˜Ÿåˆ—çš„åŸºç¡€ä¿¡æ¯ï¼ˆæ€»åç§»é‡ã€è½¦å¢å®¹é‡ç­‰ï¼‰
- ä½¿ç”¨ `VarHandle` æä¾›åŸå­æ“ä½œæ”¯æŒ

#### 3. JSharedMemCarriage

- é€»è¾‘è½¦å¢ï¼Œç®¡ç†å¤šä¸ª SMG æ®µ
- æŒ‰éœ€åŠ è½½å’Œå¸è½½å†…å­˜æ˜ å°„æ–‡ä»¶

#### 4. JSharedMemSegment

- å•ä¸ªå†…å­˜æ®µï¼Œå¯¹åº”ä¸€ä¸ª SMG
- æä¾›çŠ¶æ€ç®¡ç†å’Œæ•°æ®è¯»å†™åŠŸèƒ½

#### 5. JSharedMemReader

- æ¶ˆè´¹è€…ç«¯è¯»å–å™¨
- æ”¯æŒå¤šçº¿ç¨‹å¹¶å‘æ¶ˆè´¹

## ğŸ› ï¸ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Java 17 æˆ–æ›´é«˜ç‰ˆæœ¬
- Maven 3.6+ (æˆ–ä½¿ç”¨ Maven Wrapper)

### å®‰è£…ä¸æ„å»º

```bash
<dependency>
    <groupId>io.github.sunleader1997</groupId>
    <artifactId>JMemQueue</artifactId>
    <version>1.0.1</version>
</dependency>
```

### ç”Ÿäº§è€…ç¤ºä¾‹

```java
import io.github.sunleader1997.jmemqueue.JSharedMemQueue;

// åˆ›å»ºå…±äº«å†…å­˜é˜Ÿåˆ—
JSharedMemQueue queue = new JSharedMemQueue("my-topic", 2048);

// å†™å…¥æ•°æ®
String message = "Hello, Shared Memory Queue!";
byte[] data = message.getBytes(StandardCharsets.UTF_8);
boolean success = queue.enqueue(data);

System.out.println("æ¶ˆæ¯å…¥é˜Ÿ: "+success);
```

### æ¶ˆè´¹è€…ç¤ºä¾‹

```java
import io.github.sunleader1997.jmemqueue.JSharedMemQueue;
import io.github.sunleader1997.jmemqueue.JSharedMemReader;

// åˆ›å»ºé˜Ÿåˆ—å®ä¾‹
JSharedMemQueue queue = new JSharedMemQueue("my-topic", 2048);

// åˆ›å»ºè¯»å–å™¨
JSharedMemReader reader = queue.createReader();

// æ¶ˆè´¹æ¶ˆæ¯
byte[] data = reader.dequeue();
if(data !=null){
    String message = new String(data, StandardCharsets.UTF_8);
    System.out.println("æ”¶åˆ°æ¶ˆæ¯: "+message);
}
```

## âš¡ æ€§èƒ½åŸºå‡†

åœ¨å…¸å‹ç¡¬ä»¶ç¯å¢ƒä¸‹ï¼ˆIntel i7, 16GB RAMï¼‰ï¼ŒJMemQueue è¾¾åˆ°ä»¥ä¸‹æ€§èƒ½æŒ‡æ ‡ï¼š

- **windows ååé‡**: å•çº¿ç¨‹ 200ä¸‡+ æ¡æ¶ˆæ¯/ç§’ 4çº¿ç¨‹(å¤šè¿›ç¨‹æ¶ˆè´¹) 600ä¸‡+ æ¡æ¶ˆæ¯/ç§’
- **linux ååé‡**: 4çº¿ç¨‹(å¤šè¿›ç¨‹æ¶ˆè´¹) 1800ä¸‡+ æ¡æ¶ˆæ¯/ç§’
- **å»¶è¿Ÿ**: å¹³å‡ < 1 å¾®ç§’
- **å†…å­˜ä½¿ç”¨**: æ¯ä¸ª SMG å›ºå®š 1KBï¼Œæ”¯æŒåŠ¨æ€æ‰©å±•
- **å¹¶å‘**: æ”¯æŒæ•°ç™¾ä¸ªç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çº¿ç¨‹


```shell
windows
========== æ¶ˆè´¹è€…æµ‹è¯•ç»Ÿè®¡ ==========
è½¦å¢å®¹é‡: 1024000
æ€»æ¶ˆæ¯å®¹é‡: 1024000
æˆåŠŸæ¶ˆè´¹æ¶ˆæ¯æ•°: 4096000
dequeueè¿”å›nullæ¬¡æ•°: 0
æ€»è€—æ—¶: 686 ms
æ¶ˆè´¹ååé‡: 5970845 msg/s
ä¸šåŠ¡çº¿ç¨‹æ•°: 4
===================================
ubuntu
========== æ¶ˆè´¹è€…æµ‹è¯•ç»Ÿè®¡ ==========
è½¦å¢å®¹é‡: 1024000
æ€»æ¶ˆæ¯å®¹é‡: 1024000
æˆåŠŸæ¶ˆè´¹æ¶ˆæ¯æ•°: 4096000
dequeueè¿”å›nullæ¬¡æ•°: 0
æ€»è€—æ—¶: 226 ms
æ¶ˆè´¹ååé‡: 18123893 msg/s
ä¸šåŠ¡çº¿ç¨‹æ•°: 4
===================================
```


## ğŸ”§ é…ç½®å‚æ•°

### é˜Ÿåˆ—å‚æ•°

- `topic`: é˜Ÿåˆ—ä¸»é¢˜åç§°ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„é˜Ÿåˆ—å®ä¾‹
- `capacity`: é˜Ÿåˆ—å®¹é‡ï¼ˆSMG æ•°é‡ï¼‰ï¼Œå½±å“å†…å­˜ä½¿ç”¨å’Œæ€§èƒ½
- `overwrite`: æ˜¯å¦è¦†ç›–ç°æœ‰é˜Ÿåˆ—æ•°æ®

### ç³»ç»Ÿå‚æ•°

- `Dictionary.PARENT_DIR`: å…±äº«å†…å­˜æ–‡ä»¶å­˜å‚¨ç›®å½•ï¼ˆé»˜è®¤ `${tmp}/JSMQ/`ï¼‰

## ğŸ“ æ–‡ä»¶ç»“æ„

JMemQueue åœ¨ç³»ç»Ÿä¸­åˆ›å»ºä»¥ä¸‹æ–‡ä»¶ï¼š

- `${tmp}/JSMQ/ipc_{topic}.base` - é˜Ÿåˆ—åŸºç¡€ä¿¡æ¯æ–‡ä»¶
- `${tmp}/JSMQ/ipc_{topic}.dat.{n}` - æ•°æ®è½¦å¢æ–‡ä»¶
- `${tmp}/JSMQ/ipc_{topic}.reader` - è¯»å–å™¨çŠ¶æ€æ–‡ä»¶

## ğŸ§ª æµ‹è¯•å¥—ä»¶

é¡¹ç›®åŒ…å«å®Œæ•´çš„æ€§èƒ½æµ‹è¯•ç”¨ä¾‹ï¼Œå¯éªŒè¯ååé‡å’Œæ­£ç¡®æ€§ï¼š

```bash
# è¿è¡Œæµ‹è¯•
./mvn test

# è¿è¡Œç‰¹å®šæµ‹è¯•
./mvn test -Dtest=ConsumerTest
```

## ğŸ”’ çº¿ç¨‹å®‰å…¨

- æ‰€æœ‰çŠ¶æ€å˜æ›´ä½¿ç”¨ CAS æ“ä½œä¿è¯åŸå­æ€§
- è¯»å†™åˆ†ç¦»ï¼Œé¿å…é”ç«äº‰
- æ”¯æŒå¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…æ¨¡å¼

## ğŸ“ˆ æ‰©å±•æ€§

- åŠ¨æ€è½¦å¢ç®¡ç†ï¼Œæ”¯æŒ TB çº§åˆ«æ•°æ®å­˜å‚¨
- å¯é…ç½®çš„å†…å­˜æ®µå¤§å°
- æ”¯æŒå¤šç§æ•°æ®æ ¼å¼åºåˆ—åŒ–

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Request æ¥æ”¹è¿› JMemQueueï¼

## ğŸ“„ è®¸å¯è¯

Apache License 2.0